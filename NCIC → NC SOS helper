// ==UserScript==
// @name         NCIC → NC SOS helper
// @namespace    mci-tools
// @version      1.2
// @description  From NCIC app, open NC SOS search with name prefilled; after you pick a company, auto-open filings and the latest PDF.
// @match        http://localhost:5000/*
// @match        http://127.0.0.1:5000/*
// @match        http://192.168.1.203:5000/*
// @match        https://www.sosnc.gov/online_services/search/by_title/search_Business_Registration*
// @match        https://www.sosnc.gov/online_services/search/Business_Registration_Results*
// @match        https://www.sosnc.gov/online_services/search/profile_filings/*
// @grant        GM_setValue
// @grant        GM_getValue
// @updateURL    https://raw.githubusercontent.com/Synth6/Tampermonkey/main/MCI%20Master%20Menu.user.js
// @downloadURL  https://raw.githubusercontent.com/Synth6/Tampermonkey/main/MCI%20Master%20Menu.user.js
// ==/UserScript==

(function () {
  'use strict';

  const host = location.hostname;
  const port = location.port;
  const href = location.href;

  const isNcicApp =
    port === '5000' &&
    (host === 'localhost' || host === '127.0.0.1' || host === '192.168.1.203');

  const isSosSearch =
    host === 'www.sosnc.gov' &&
    href.startsWith(
      'https://www.sosnc.gov/online_services/search/by_title/search_Business_Registration'
    );

  const isSosResults =
    host === 'www.sosnc.gov' &&
    href.startsWith(
      'https://www.sosnc.gov/online_services/search/Business_Registration_Results'
    );

  const isSosFilings =
    host === 'www.sosnc.gov' &&
    href.startsWith(
      'https://www.sosnc.gov/online_services/search/profile_filings/'
    );

  // -------- PART 1: On your NCIC app (Flask page) --------
  if (isNcicApp) {
    // Delegate clicks on the existing SOS button rendered by Flask
    document.addEventListener('click', function (e) {
      const btn = e.target.closest('.sos-btn');
      if (!btn) return;

      const name = (btn.dataset.employer || '').trim();
      if (!name) return;

      // Remember the name for the SOS page
      GM_setValue('lastBusinessName', name);

      // Open SOS search page in a new tab
      window.open(
        'https://www.sosnc.gov/online_services/search/by_title/search_Business_Registration',
        '_blank',
        'noopener'
      );
    });
  }

  // -------- PART 2: On the SOS search page (prefill & search) --------
  if (isSosSearch) {
    window.addEventListener('load', async function () {
      const name = (await GM_getValue('lastBusinessName', '')).trim();
      if (!name) return;

      const input = document.getElementById('SearchCriteria');
      const button = document.getElementById('SubmitButton');
      if (!input || !button) return;

      input.value = name;
      input.dispatchEvent(new Event('input', { bubbles: true }));
      button.click();
    });
  }

  // -------- PART 3: On the SOS results page (you click company → script clicks "View filings") --------
  if (isSosResults) {
    document.addEventListener('click', function (e) {
      const accordionBtn = e.target.closest('button.usa-accordion__button');
      if (!accordionBtn) return;

      // Let their click expand the accordion first
      const panelId = accordionBtn.getAttribute('aria-controls');
      if (!panelId) return;

      setTimeout(() => {
        const panel = document.getElementById(panelId);
        if (!panel) return;

        // Find the "View filings" link inside that panel
        const filingsLink = Array.from(
          panel.querySelectorAll('a.searchResultsLink')
        ).find(a =>
          a.textContent.trim().toLowerCase().startsWith('view filings')
        );

        if (filingsLink) {
          filingsLink.click();
        }
      }, 100); // small delay so the DOM is ready
    });
  }

  // -------- PART 4: On the profile_filings page (auto-click latest "View Filing(PDF)") --------
  if (isSosFilings) {
    window.addEventListener('load', function () {
      // All "View Filing(PDF)" links are the ones that call ImageClick(...)
      const allLinks = Array.from(
        document.querySelectorAll('a[id][onclick*="ImageClick"]')
      );

      const pdfLinks = allLinks.filter(a =>
        a.textContent.trim().toLowerCase().startsWith('view filing')
      );

      if (!pdfLinks.length) return;

      // The bottom one should be the most recent filing
      const latest = pdfLinks[pdfLinks.length - 1];
      latest.click();
    });
  }
})();
